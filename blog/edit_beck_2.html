<!doctype html>
<html>
<head>
<meta charset="utf-8">
<link rel="shortcut icon" type="image/x-icon" href="http://1.gravatar.com/blavatar/5eb168b0154768602b7da05b54081381?s=16" sizes="16x16">
<link rel="icon" type="image/x-icon" href="http://1.gravatar.com/blavatar/5eb168b0154768602b7da05b54081381?s=16" sizes="16x16">

<title>TEDxNCCU</title>
<link href="../css/jquery-ui.css" rel="stylesheet" type="text/css">
<!--link href="css/bootstrap.min.css" rel="stylesheet" type="text/css"-->
<link href="../css/reset.css" rel="stylesheet" type="text/css">
<!--link href="css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"-->
<link href="../css/tedxnccu2.css" rel="stylesheet" type="text/css">

<style>
.control-btn { min-width:20px; min-height:20px; background:rgba(3,3,3,.8); border-radius:2px; color:#818181; float:left; margin-right:10px; font-size:1.5em; padding:5px; margin-bottom:10px; cursor:pointer; }
.control-btn:hover { color : white;}
.fr { float:right;}
.bold { font-weight:bold;}
.edit {width:918px; height:auto; min-height:300px; padding:20px; background:#FFFFFF; }
.edit-zone a { cursor:pointer; }
img.l { float:left; width:300px; margin:20px 20px 20px 0;}
img.r { float:right; width:300px;  margin:20px 0 20px 20px;}
img.m { width:100%;}
b { font-weight:bold;}

#pre-img-area {float:left; width:400px; margin-left:10px; height:300px; background:rgba(0,0,0,.0);}
#pre-img {  margin:75px auto; background: rgba(0,0,0,.2); color:gray;width:150px; height:150px; }
#pre-img:hover { background:rgba(0,0,0,.1); cursor:pointer;  }
.pre-img { background-position:center; background-size:cover; background-repeat:no-repeat; width:150px; height:150px;}

.control-group { width:100%; margin-bottom:10px; width:550px; }
.control-label { float:left; width:100px; text-align:left;padding: 14px 0px;background:rgba(3,3,3,.8); border-radius:2px; color:white; float:left; margin-right:10px; font-size:1em; text-align:center;    }
.controls { float:left; width:432px;}
.input-xlarge { margin:0px 5px; width:406px; height:40px; padding: 0px 5px; font-size:1em;}
.help-block { padding-left:12px; color:gray;}

.appendArea { position:fixed; width:100%; min-height:1080px; background:rgba(0,0,0,.95); display:none; z-index:50; top:0; left:0;}
.apdInner { margin-top:100px;}
.apdInner > p ,.apdInner > ul{color:white;}

.apdBtn{ float:right; text-align: center; color:white; background:#666666;width:100px;padding: 14px 0px; border-radius:2px; color:white; }
.apdBtn:hover { background:#999999; cursor:pointer;}

.parseBtn { width:48%; background:#000000; border-radius:5px; color:white; font-weight:bolder; float:left; }
.parseBtn:first-child { margin-right:4%;}
.parseBtn:hover { cursor:pointer; background:#333333;}
.parseBtn > div { text-align:center; margin:20px auto;}
</style>

</head>
<body>
<nav>
	<div id="nav" class="container clearfix">
		<div style="float:left;">
			<img src="../img/TEDxNCCU5.png" height="30" style="margin:8px 0px 3px 0px;">
		</div>
		<div style="float:right">
			<ul id="mainNav" class="hrzUL clearfix">
				<li><a href="../index.html">首頁</a></li>
				<li><a href="../spnsors.html">贊助夥伴</a>
				</li>
				<li class="withSubNav clearfix">
					<a href="index.html" >TED活動</a>
					<ul class="subNav">
						<li><a href="#">2013 From Idea To Action</a></li>
					</ul>
				</li>
				<li class="withSubNav clearfix">
					<a href="../blog/index.html">文章分享</a>
					<ul class="subNav">
						<li><a href="#">部落格</a></li>
						<li><a href="#">TED TALK</a></li>
						<li><a href="#">活動成果</a></li>
					</ul>
				</li>
				<li><a href="../aboutTEDx.html">關於TEDx</a></li>	
				<li class="withSubNav clearfix"><a href="../about.html">關於我們</a>
					<ul class="subNav">
						<li><a href="#">團隊介紹</a></li>
						<li><a href="#">團隊理念</a></li>
						<li><a href="../contact.html">聯繫我們</a></li>
					</ul>
				</li>
				<li><a></a></li>	
			</ul>
		</div>
	</div>
</nav>
<div style="width:100%; height:44px;">
</div>



<div id="banner">
	<div class="bannerPic-small-cover">
		<div class="container">
			<div class="title">
				<h1>TEDxNCCU 文章發表</h1>
			</div>
			<div style="padding:10px; color:white; display:block; ">
				文章列表&nbsp;&nbsp; >> &nbsp;&nbsp;文章發表
			</div>

		</div>
	</div>
	<div class="bannerPic-small shd-large">
	</div>
	
	<!--div class="bread subBanner" style="position:absolute; top:250px; z-index:30;">
		<div class="container">

		</div>
	</div-->	
</div>


<!--div id="banner" class="clearfix">
	<div class="bannerPic-small shd" style="background-image:url(../../image/7445668486_2ffafcff86_o.jpg);">
	</div>
</div>
<div class="bread subBanner">
	<div class="container">
		&gt;&gt; 文章分享
	</div>
</div-->
<div id="formCon" class="outer bg" >
	<div class="container clearfix">
		<h3>文章資訊</h3>
		<form class="form-horizontal" style="float:left;">
			<!-- Text input-->
			<div class="control-group clearfix">
				<label class="control-label" for="subject">主題</label>
				<div class="controls">
					<input id="subject" name="subject" type="text" placeholder="請輸入文章名稱" class="input-xlarge" required>
					
				</div>
			</div>
			
			<!-- Select Basic -->
			<div class="control-group clearfix">
				<label class="control-label" for="type">類別</label>
				<div class="controls">
					<select id="type" name="type" class="input-xlarge">
						<option class="input-xlarge">部落格文章</option>
						<option class="input-xlarge">TEDx演講</option>
						<option class="input-xlarge">活動成果文</option>
					</select>
				</div>
			</div>
			
			<!-- Text input-->
			<div class="control-group clearfix">
				<label class="control-label" for="writer">作者</label>
				<div class="controls">
					<input id="writer" name="writer" type="text" placeholder="請務必填寫，可以填筆名" class="input-xlarge">
				</div>
			</div>
			
			<!-- Text input-->
			<div class="control-group clearfix">
				<label class="control-label" for="date">日期</label>
				<div class="controls">
					<input id="date" name="date" type="text" placeholder="日期" class="input-xlarge" required>
					
				</div>
			</div>
			
			<!-- Textarea -->
			<div class="control-group clearfix">
				<label class="control-label" for="abstract">文章摘要</label>
				<div class="controls">                     
					<textarea id="abstract" class="input-xlarge" name="abstract" style="height:80px;">請輸入約 100 ~ 200 字的文章摘要，越吸引人越好</textarea>
				</div>
			</div>
					<input id="imgSrc" name="imgSrc" hidden="true">
		</form>
		
		<div id="pre-img-area">
			<div id="pre-img">請點選以插入縮圖</div>
		</div>
	</div>
</div>

<div class="outer bg">
	<div class="editArea container">
		<div class="edit-pannel clearfix">
			<label class="control-label" for="content" style="position:relative; top:-10px;">內文</label>
			<div id="pat" class="control-btn shd ">Paste</div>
			<div id="h" class="control-btn shd">H</div>
			<div id="b" class="control-btn shd">B</div>			
			<div id="p" class="control-btn shd">P</div>			

			<div id="a" class="control-btn shd">A</div>
			<div id="v" class="control-btn shd">V</div>			
			<div id="g" class="control-btn shd">G</div>		
			<div id="html" class="control-btn shd fr">Source</div>		
			<div id="help" class="control-btn shd fr">說明</div>		
		</div>
	
		<div id="content" contenteditable="true" class="edit-zone shd edit" ><p>Put Yor Content Here</p></div>
		<textarea id="source-zone" class="edit" style="display:none;"></textarea>
		
	</div>
</div>

<div class="outer bg">
	<div class="container clearfix">
		<div class="parseBtn" id="save"><div>存入草稿</div></div><div class="parseBtn" id="submmit"><div>送出文章</div></div>
	</div>
</div>

<div class="appendArea" style="">
</div>

<footer  class="outer-small">
	<div class="container clearfix">
		<ul class="hrzUL foot_nav">
			<li><a href="act/FromIdeaToAction.html">From Idea to Action</a></li>
			<li><a href="sponsor.html">贊助我們</a></li>
			<li><a href="contact.html">聯絡我們</a></li>
			<li><a href="manageLogin.html">管理模式</a></li>
		</ul>
	</div>
</footer>

<script src="../js/jquery.min.js" type="text/javascript"></script>
<script src="../js/jquery-ui.js" type="text/javascript"></script>
<script src="../js/parse-1.2.8.min.js" type="text/javascript"></script>
<script src="../js/TEDxNCCU.js" type="text/javascript"></script>
<script type="text/javascript">
$('.edit-pannel').disableSelection();
$('.edit-pannel').children().each(function(index, element) {
	$(element).disableSelection();
});

$(document).ready(function(e) {
	
	$('#date').datepicker().datepicker("option", "dateFormat",'yy-mm-dd').datepicker("setDate",new Date());;
	//alert ('請注意，此發文區不是一個很完善的文字編輯區\n 請務必在word打好純文字，\n這裡只提供做格式設定、貼圖以及貼影片\n請小心使用');
	showHelp ();
});
var sel,range;
var ele;
var selText = "";

var startineditArea = false ;
var endineditArea = false ;
$('.edit-zone').keydown(function (){check ();startineditArea =true;}).mousedown((function (){check ();startineditArea =true;}));

$('.edit-zone').keyup(getSelectionRange).mouseup(getSelectionRange);

function getSelectionRange() {
		endineditArea = true;
    if (window.getSelection) {
				
        sel = window.getSelection(); console.log(sel.rangeCount);
        if (sel.rangeCount) {
						range = sel.getRangeAt(0); 
						selText = sel.toString();
						console.log (range);


            return sel.getRangeAt(0);
        }
    } else if (document.selection) {
				range = document.selection.createRange();
				selText = sel.toString();

        return document.selection.createRange();
			//selText = document.selection.createRange().text;
    }
		
		
    return null;
}

function update(e) {

	if (window.getSelection) {
			var sel = window.getSelection();
			var range = sel.getRangeAt(0);
			console.log (sel);
			console.log(range.startContainer.parentElement.tagName);
			
	} else if (document.selection && document.selection.type != "Control") {
			selText = document.selection.createRange().text;
	}
//	console.log (selText);
}

function replaceSelectedText(replacementText) {
    var sel;
    if (window.getSelection) {
        sel = window.getSelection();
        if (sel.rangeCount) {
            range = sel.getRangeAt(0);
						//console.log(range);
            range.deleteContents();
            range.insertNode(replacementText);
        }
    } else if (document.selection && document.selection.createRange) {
        range = document.selection.createRange();
        range.text = replacementText;
    }
}

function chgTag (tagName)
{	
	var rangeParent = range.startContainer.parentElement;
	range.selectNodeContents(rangeParent);console.log(range);
	//var sel = window.getSelection();
	sel.removeAllRanges();
	sel.addRange(range);
	range = sel.getRangeAt(0);console.log(range);
	var prnName = range.startContainer.parentElement.tagName.toLowerCase();
	var $prn = $(range.startContainer.parentElement);
	if ( !$prn.hasClass('edit-zone')|| !$prn.hasClass('editArea'))
	{
		var inn = $prn.html();
		if (prnName !== tagName )
		{
			$prn.wrap('<'+tagName+'>');
			//console.log (range.startContainer.parentElement);			
		}else {
			$prn.wrap('<p>');
		}
		$prn.parent().html(inn);
	}
	sel.removeAllRanges();
	sel.addRange(range);
}

function check (){
	var b = (	startineditArea && endineditArea); console.log (b);
	startineditArea = false;
	endineditArea = false;
	if(b)	return true ; else return false ;

}
$('#h').click (function (){
	(check()) ?	chgTag ('h3') :  null ;
});

$('#b').click (function(){
	var ele = document.createElement('b')
	var $ele = $(ele);
	$ele.text(selText);
	if (range.startContainer.parentElement.tagName.toLowerCase('b') === 'b'){
		range.setStart(range.startContainer,0);
	}
	if (range.endContainer.parentElement.tagName.toLowerCase('b') === 'b'){
		range.setEnd(range.endContainer.toString().length);
	}
	
	sel.removeAllRanges();
	sel.addRange(range);
	range.deleteContents();
	range.insertNode (ele);
	sel.removeAllRanges();
	sel.addRange(range);

});

$('#p').click(function (){
	chgTag ('p');
});


$('#a').click(function (){
	var l = prompt('請貼上超連結');
	var a = document.createElement('a');
	$(a).attr('href',l)

	if (selText === '' || selText === null  ) {
		$(a).html(l);
	}else{
		$(a).html(selText);
	}
	replaceSelectedText (a);
});
$('#help').click(function (){
	showHelp();
});

$('#v').click(function (){

	var l = prompt('請貼上Youtube連結，\n如果要崁入，請先按確定');
	if (l === null || l !=='')
	{
		var	ele = document.createElement('iframe');
		var a = l.search('\\?'); console.log (a);
		var srh = l.substring(a,l.length); console.log(srh);
		var vID = getURLParameter('v',srh);console.log(vID);
		var src = 'http://www.youtube.com/embed/' + vID ;
		var ifm = document.createElement('iframe');
		ifm.setAttribute('src',src);
		ifm.setAttribute('width','960');
		ifm.setAttribute('height','540');
		ifm.setAttribute('framevorder','0');
		ifm.setAttribute('allowfullscreen','true');
		replaceSelectedText (ifm);
	}else 
	{
		l = prompt ('請貼上崁入標籤 (ex:<iframe.....)')
		var ele = document.createElement('div');
		$(ele).html(l);
		replaceSelectedText (ifm);
	}
/*	var pre ='<iframe width="960" height="540" src="http://www.youtube.com/embed/',
	aft = '" frameborder="0" allowfullscreen></iframe>';
	var ifm = pre + vID + aft ;
	
	var parser = new DOMParser();
	$.parseHTML(ifm);
	var ele  = parser.parseFromString(ifm, "text/xml");
*/console.log (ifm);
	

});

$('#g').click(function (e){
	var type = prompt('請選擇圖片位置：左、中、右','中');
	var src = prompt('請貼入圖片連結','http://...');
	var cls ='';
	console.log (type);
	switch(type) {
		case '左': cls = 'l';break;
		case '右': cls = 'r';break;
		default :cls = 'm';
	}
	var ele = document.createElement('img');
	ele.setAttribute('class',cls);
	ele.setAttribute('src',src);
	replaceSelectedText (ele);
});

$('.control-btn').each(function(index, element) {
	disableSelect(element);
});


function disableSelect(el){			
    if(el.addEventListener){
        el.addEventListener("mousedown",disabler,"false");
    } else {
        el.attachEvent("onselectstart",disabler);
    }
}
function disabler(e){
    if(e.preventDefault){ e.preventDefault(); }
    return false;
}

</script>


<script type="text/javascript">

</script>
<script type="text/javascript">
var editingSource = false;
    // 轉換為原始碼
		$('#html').click(function (){
			if (!editingSource){
				var b = $('.edit-zone').html();//console.log (b);
				$('.edit-zone').hide();
				var a = getSourceCode(b);
				$('#source-zone').val(a).show();
				$('#html').html('HTML');
				editingSource = true;
			} else {
				var b = $('#source-zone').val();//console.log (b);
				$('#source-zone').hide();
				var a = getHTMLCode(b);
				$('.edit-zone').html(a).show();
				$('#html').html('Source');
				editingSource = false;
			}
		});
    var getSourceCode = function (sCode) {
        var oPattern = /(<[\/\d="a-zA-Z ]+>)</gi; 
				var result;
				while ( (result = oPattern.exec(sCode)) !== null )
				{
					console.log(result);
				}
        var sReplace = '$1\n<'; 
        sCode = sCode.replace(/<br>/g,'\n');//
        sCode = sCode.replace(oPattern, sReplace);console.log(sCode);
       	sCode = sCode.replace(oPattern, sReplace);console.log(sCode);
        return sCode;
    };

    // 轉換成 HTML 檢視
    var getHTMLCode = function (sCode) {                        
        var oPattern = /(<[\/\d="a-zA-Z ]+>)\s+</gi; 
        var sReplace = '$1<'; 
        sCode = sCode.replace(oPattern, sReplace);
        sCode = sCode.replace(oPattern, sReplace);
        sCode = sCode.replace(/\n/g, '<br>');
        return sCode;
    };
</script>

<script type="text/javascript">
function getURLParameter(name,urlSearch) {
    return decodeURI(
        (RegExp(name + '=' + '(.+?)(&|$)').exec(urlSearch)||[,null])[1]
    );
}</script>


<script type="text/javascript">

	$('#pre-img').click(function (){
		var a = prompt ('請插入圖片連結');
		if (a){
			console.log ('good');
			var b = '<div class="pre-img" style="background-image:url('+a+')"></div>';
			$('#imgSrc').val(a);
			$('#pre-img').empty().append(b);
		}
	})
	

</script>
<script type="text/javascript">
$(document).on('submit','#pasteForm',process);
function process () {
	var a = '<p>' + $('#paste').val().replace(/\n/g,"</p><p>");
//	console.log (a);
//  document.execCommand('inserttext', false,a);
//	$('#appendArea').empty().append(a);
	$('.edit-zone').append(a);
	$('#paste').val('');
	return false;
}

var isNew = true;
	var pasteForm = '<div class="container apdInner"><h3 style="color:white;">貼上純文字</h3><p style="color:white;">這個區塊會將純文字貼上，保留純文字，並去除<b>格式、圖片和影片</b></p><form sytle="" id="pasteForm"><textarea id="paste" style="padding:20px; width:918px; height:300px;"></textarea><button type="submit" class="formBtn apdBtn">送出</button></form></div>'
	var $apd = $('.appendArea');
	if (isNew){
		$('.edit-zone').click(function(){
			showApd(pasteForm);
			$('.edit-zone').unbind('click');
		});	
	}
	$('#pat').click(function(){showApd(pasteForm);} );
	function eptApd  (){
		$apd.fadeOut( function (){
			$apd.empty();
			$apd.unbind('click');
		});
	}
	function showApd (theForm){
		$apd.append(theForm).fadeIn();
		$apd.on('click','.apdInner',function (e){e.stopPropogation();});
		$apd.click(eptApd);
		$apd.on('click','.apdBtn',eptApd);

	}
// help doc
	function showHelp (){
		var helpDovForm = document.createElement('div');
		$(helpDovForm).load('_helpDoc.html');
		showApd (helpDovForm);
	}
</script>

<script type="text/javascript">

function getArtCode() {
	if (!editingSource){
		$('#html').trigger('click');
	}
	return ($('#source-zone').val())

} 

$('#save').click(toSave)
function toSave (){
	Parse.initialize("BFuEvRNBwRW6MScfT6nIUrhZaKMBriF4VpAC0DwD", "MvYBNO5NQ6DeixPpLgmH60wQDQvQrf5nIrx6RHgy");
	var TEDxBlog = Parse.Object.extend("TEDxBLOG_backup");
	var tedxblog = new TEDxBlog();

	var article = {
		subject:$('#subject').val(),
		type:$('#type').val(),
		writer:$('#writer').val(),
		date:$('#date').val(),
		preImg:$('#imgSrc').val(),
		abstract:$('#abstract').val(),
		content:getArtCode()
	}
	if (article){
		tedxblog.save(article, {
			success: function(object) {
				alert("文章已經成功保存!! 繼續加油!!");
			},
			error:function (e,objdect){
					console.log(e,object);
			}
		});	
	}
}
$("#submmit").click(toSubmit);
function toSubmit (){
	Parse.initialize("BFuEvRNBwRW6MScfT6nIUrhZaKMBriF4VpAC0DwD", "MvYBNO5NQ6DeixPpLgmH60wQDQvQrf5nIrx6RHgy");
	var TEDxBLOG = Parse.Object.extend("TEDxBLOG");
	var tedxblog = new TEDxBLOG();

	var article = {
		subject:$('#subject').val(),
		type:$('#type').val(),
		writer:$('#writer').val(),
		date:$('#date').val(),
		preImg:$('#imgSrc').val(),
		abstract:$('#abstract').val(),
		content:getArtCode()
	}
	if (article){
		tedxblog.save(article, {
			success: function(object) {
				alert("文章已經送出!!");
			},
			error:function (e,objdect){
					console.log(e,object);
			}			
		});	
	}
	
}
</script>
</body>
</html>
